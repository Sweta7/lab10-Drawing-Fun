

<!DOCTYPE html>
<html>
<head>
	<title>COSC346 Week 10 - Drawing Fun</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   	<link rel="stylesheet" type="text/css" href="../phplabbook/labbookswift.css">
	<link rel="stylesheet" type="text/css" href="../cosc346labstyle.css">
	<script src="../jquery-1.11.1.min.js"></script>
	<script src="../toc.min.js"></script>
	<script src="../cosc346labscript.js"></script>
</head>
<body>

	<!-- Banner -->
	<div class="banner">
		<a href="../../labs.php">COSC346 - Object Oriented Programming and User Interfaces</a>
	</div>
		
	<!-- Lab title -->		
	<h1>Week 10—Drawing Fun</h1>
	
	<!-- Table of Contents -->
	<div id="toc"></div>
		
		
	<h2>Goals</h2>
	<div class="block">
		<ul class="toplist">
			<li>Explore scroll views.</li>
			<li>Use drawing functions.</li>
			<li>Glimpse bindings.</li>
			<li>Work with mouse and keyboard events.</li>
		</ul>
	</div>


	<h2>Drawing Fun</h2>

	<p>
	  (This lab exercise is based on material from Chapters 17 and 18 of the 4th edition of Hillegass and Preble.)
	</p>

	<p>
	  Review material about custom views and the view hierarchy. This is covered in lectures, and also at the start of Chapter 17 in the 4th edition of Hillegass and Preble (Up to "Get a View to Draw Itself").
	</p>

	<h3>A custom view</h3>

	<p>
	  Create a new project in Xcode that is a Cocoa Application named "DrawingFun". Unlike in past exercises, we will use storyboards within Xcode this time&mdash;i.e., the only type of Cocoa Application template provided in versions of Xcode from 8.3 up.
	  
	</p>

	<p>
	  Select the "DrawingFun" folder in the Xcode project navigator.
	  Then, using the File -> New menu, create a New File named "StretchView"  that is a Cocoa class, and specifically a subclass of <code>NSView</code>.
	</p>

	<p>
	  In the Interface Builder, examine "<code>Main.storyboard</code>". Using the Library (bottom right-hand window) look up "Custom View", and drag and drop such a custom view into the View Controller's <code>View</code> (use the Document Outline view, if needed). In the Identity Inspector (right-hand-side panels), set the class of this "Custom View" to be <code>StretchView</code> rather than <code>NSView</code>.
	</p>

	<p>
	  (In the 4th ed., you should have reached the start of the "Size Inspector" section.)
	</p>

	<h3>Controlling StretchView's size</h3>

	<p>
	  You want to ensure that the <code>StretchView</code> resizes along with its containing content view (of the window). The 4th edition of H&amp;P shows an older version of Xcode. The 5th edition of H&amp;P covers the Auto Layout features of Xcode 6, 7 and 8, see "Cleaning up with Auto Layout" up to "Drawing Images". We will describe the steps below, also.
	</p>

	<p>
	  In the bottom right corner of the <code>Main.storyboard</code> document (as shown in the Interface builder) there are four small icons. You can hover over them to see their name in their tool-tip. Select your custom view, and click the "Add New Constraints" icon. A pop-up window will appear: in the "Add New Constraints" section, click the lines that extend out from the square so that they are all solid red. You may need to change each of the four text fields to the value 20. Then click the "Add 4 constraints" button. You will see the constraints in the IB whenever your <code>StretchView</code> is selected, as four struts connecting the edges of <code>StretchView</code> to the edges of the content view.
	</p>

	<h3>The draw message</h3>

	<p>Your view will have its <code>draw:</code> (renamed from <code>drawRect:</code>) method called when it needs to draw or redraw itself. A rectangle passed with the method call will indicate the specific area that needs redrawing.</p>

	<p>
	  Note that if you need to cause some other view to be redrawn, you do not call its <code>draw</code> method directly. Instead you set <code>needsDisplay</code> to be true.
	</p>

	<p>
	  Set the <code>draw:</code> method in <code>StretchView</code> to fill the rectangle to green using the following code. (You have seen the bounds concept in the frame and bounds demo.)
	</p>

	<div class="codeblock">
<div class="codeblocktitle"><a href="code/01/StretchView.swift">StretchView.swift</a></div>
<pre class="linenumbers unselectable" style="float: left;">01:
02:
03:
04:
05:
06:
07:
08:
09:
10:
11:
12:
13:
14:
15:
16:
17:
18:
19:
</pre><pre class="code">
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"><span class="swiftcomment">//  StretchView.swift</span></span>
<span class="swiftcode"><span class="swiftcomment">//  DrawingFun</span></span>
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"><span class="swiftcomment">//  Created by David Eyers on 20/09/16.</span></span>
<span class="swiftcode"><span class="swiftcomment">//  Updated for Xcode 8.3 and Swift 3.x in September 2017</span></span>
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"></span>
<span class="swiftcode"><span class="swiftkeyword">import</span> Cocoa</span>
<span class="swiftcode"></span>
<span class="swiftcode"><span class="swiftkeyword">class</span> StretchView: NSView {</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> draw(_ dirtyRect: NSRect) {</span>
<span class="swiftcode">        <span class="swiftkeyword">super</span>.draw(dirtyRect)</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> bounds = <span class="swiftkeyword">self</span>.bounds</span>
<span class="swiftcode">        NSColor.green.<span class="swiftkeyword">set</span>()</span>
<span class="swiftcode">        NSBezierPath.fill(bounds)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">}</span>
</pre>
</div>
	

	<p>
	  Run your application to check that your content view is resizing as expected.
	</p>

	<h3>Drawing with a NSBezierPath</h3>

	<p>
	  We used an <code>NSBezierPath</code> to fill a rectangle, however they can also draw lines, ovals, curves and polygons.
	</p>

	<p>
	  Use the following code to create a random <code>NSBezierPath</code> when your <code>StretchView</code> is first initialised.
	</p>

	<div class="codeblock">
<div class="codeblocktitle"><a href="code/02/StretchView.swift">StretchView.swift</a></div>
<pre class="linenumbers unselectable" style="float: left;">01:
02:
03:
04:
05:
06:
07:
08:
09:
10:
11:
12:
13:
14:
15:
16:
17:
18:
19:
20:
21:
22:
23:
24:
25:
26:
27:
28:
29:
30:
31:
32:
33:
34:
35:
36:
37:
38:
39:
40:
41:
42:
43:
44:
45:
</pre><pre class="code">
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"><span class="swiftcomment">//  StretchView.swift</span></span>
<span class="swiftcode"><span class="swiftcomment">//  DrawingFun</span></span>
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"><span class="swiftcomment">//  Created by David Eyers on 20/09/16.</span></span>
<span class="swiftcode"><span class="swiftcomment">//  Updated for Xcode 8.3 and Swift 3.x in September 2017</span></span>
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"></span>
<span class="swiftcode"><span class="swiftkeyword">import</span> Cocoa</span>
<span class="swiftcode"></span>
<span class="swiftcode"><span class="swiftkeyword">class</span> <span class="swiftdefined">StretchView</span>: NSView {</span>
<span class="swiftcode"></span>
<span class="swiftcode">    <span class="swiftkeyword">var</span> path = NSBezierPath()</span>
<span class="swiftcode"></span>
<span class="swiftcode">    required <span class="swiftkeyword">init</span>?(coder: NSCoder) {</span>
<span class="swiftcode">        <span class="swiftkeyword">super</span>.<span class="swiftkeyword">init</span>(coder: coder)</span>
<span class="swiftcode">        srandom(<span class="swiftnumber">2</span>)</span>
<span class="swiftcode">        path.lineWidth = <span class="swiftnumber">3</span>.<span class="swiftnumber">0</span> </span>
<span class="swiftcode">        <span class="swiftkeyword">var</span> p:NSPoint = <span class="swiftkeyword">self</span>.randomPoint()</span>
<span class="swiftcode">        path.move(to: p)</span>
<span class="swiftcode">        </span>
<span class="swiftcode">        <span class="swiftkeyword">for</span> _ <span class="swiftkeyword">in</span> <span class="swiftnumber">0</span>...<span class="swiftnumber">14</span> {</span>
<span class="swiftcode">            p = <span class="swiftkeyword">self</span>.randomPoint()</span>
<span class="swiftcode">            path.line(to: p)</span>
<span class="swiftcode">        }</span>
<span class="swiftcode">        path.close()</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">func</span> randomPoint()-&gt;NSPoint {</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> r:NSRect = <span class="swiftkeyword">self</span>.bounds</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> nx = r.origin.x + CGFloat(<span class="swiftclass">Int</span>(arc4random()) % <span class="swiftclass">Int</span>(r.size.width))</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> ny = r.origin.y + CGFloat(<span class="swiftclass">Int</span>(arc4random()) % <span class="swiftclass">Int</span>(r.size.height))</span>
<span class="swiftcode">        <span class="swiftkeyword">return</span> NSPoint(x: nx, y: ny)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> draw(_ dirtyRect: NSRect) {</span>
<span class="swiftcode">        <span class="swiftkeyword">super</span>.draw(dirtyRect)</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> bounds = <span class="swiftkeyword">self</span>.bounds</span>
<span class="swiftcode">        NSColor.green.<span class="swiftkeyword">set</span>()</span>
<span class="swiftcode">        NSBezierPath.fill(bounds)</span>
<span class="swiftcode">        </span>
<span class="swiftcode">        NSColor.white.<span class="swiftkeyword">set</span>()</span>
<span class="swiftcode">        path.stroke()</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">}</span>
</pre>
</div>
	

	<p>
	  See what happens if you change <code>stroke()</code> to <code>fill()</code>.
	</p>

	<h3>NSScrollView</h3>

	<p>
	  We will extend your application to allow scrolling of your artwork.
	  In the Interface Builder, select your <code>StretchView</code> and from the Editor menu, select "Embed In" -> "Scroll View".
	  Note that you will need to use the following code to override the <code>intrinsicContentSize</code>.
	</p>

	<div class="codeblock">
<div class="codeblocktitle"><a href="code/03/StretchView.swift">StretchView.swift</a></div>
<pre class="code">
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">var</span> intrinsicContentSize: NSSize {</span>
<span class="swiftcode">        <span class="swiftkeyword">return</span> NSSize(width: <span class="swiftnumber">400</span>, height: <span class="swiftnumber">400</span>)</span>
<span class="swiftcode">    }</span>
</pre>
</div>
	

	<p>
	  Now, we want the scroll view to resize with the window in the same manner as the <code>StretchView</code> used to. Repeat steps similar to the above to "Add Constraints" to the scroll view so that it resizes with the window.
	</p>

	<h3>Integrating Mouse Events</h3>

	<p>
	  We will extend your Drawing Fun application to place an image using mouse events.

	  First, you should revise the lecture material on <code>NSResponder</code> and <code>NSEvent</code>.
	  You may wish to download and experiment with the mouse and event demonstrations on the lecture notes page.
	  (This material is also covered in the first part of Chapter 18 in the 4th edition of Hillegass &amp; Preble.)
	</p>

	<p>
	  Modify your <code>StretchView</code>.swift file to incorporate mouse event methods as follows.
	</p>

	<div class="codeblock">
<div class="codeblocktitle"><a href="code/03/StretchView.swift">StretchView.swift</a></div>
<pre class="linenumbers unselectable" style="float: left;">01:
02:
03:
04:
05:
06:
07:
08:
09:
10:
11:
12:
13:
14:
15:
16:
17:
18:
19:
20:
21:
22:
23:
24:
25:
26:
27:
28:
29:
30:
31:
32:
33:
34:
35:
36:
37:
38:
39:
40:
41:
42:
43:
44:
45:
46:
47:
48:
49:
50:
51:
52:
53:
54:
55:
56:
57:
58:
59:
60:
</pre><pre class="code">
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"><span class="swiftcomment">//  StretchView.swift</span></span>
<span class="swiftcode"><span class="swiftcomment">//  DrawingFun</span></span>
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"><span class="swiftcomment">//  Created by David Eyers on 20/09/16.</span></span>
<span class="swiftcode"><span class="swiftcomment">//  Updated for Xcode 8.3 and Swift 3.x in September 2017</span></span>
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"></span>
<span class="swiftcode"><span class="swiftkeyword">import</span> Cocoa</span>
<span class="swiftcode"></span>
<span class="swiftcode"><span class="swiftkeyword">class</span> <span class="swiftdefined">StretchView</span>: NSView {</span>
<span class="swiftcode"></span>
<span class="swiftcode">    <span class="swiftkeyword">var</span> path = NSBezierPath()</span>
<span class="swiftcode"></span>
<span class="swiftcode">    required <span class="swiftkeyword">init</span>?(coder: NSCoder) {</span>
<span class="swiftcode">        <span class="swiftkeyword">super</span>.<span class="swiftkeyword">init</span>(coder: coder)</span>
<span class="swiftcode">        srandom(<span class="swiftnumber">2</span>)</span>
<span class="swiftcode">        path.lineWidth = <span class="swiftnumber">3</span>.<span class="swiftnumber">0</span> </span>
<span class="swiftcode">        <span class="swiftkeyword">var</span> p:NSPoint = <span class="swiftkeyword">self</span>.randomPoint()</span>
<span class="swiftcode">        path.move(to: p)</span>
<span class="swiftcode">        </span>
<span class="swiftcode">        <span class="swiftkeyword">for</span> _ <span class="swiftkeyword">in</span> <span class="swiftnumber">0</span>...<span class="swiftnumber">14</span> {</span>
<span class="swiftcode">            p = <span class="swiftkeyword">self</span>.randomPoint()</span>
<span class="swiftcode">            path.line(to: p)</span>
<span class="swiftcode">        }</span>
<span class="swiftcode">        path.close()</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">func</span> randomPoint()-&gt;NSPoint {</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> r:NSRect = <span class="swiftkeyword">self</span>.bounds</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> nx = r.origin.x + CGFloat(<span class="swiftclass">Int</span>(arc4random()) % <span class="swiftclass">Int</span>(r.size.width))</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> ny = r.origin.y + CGFloat(<span class="swiftclass">Int</span>(arc4random()) % <span class="swiftclass">Int</span>(r.size.height))</span>
<span class="swiftcode">        <span class="swiftkeyword">return</span> NSPoint(x: nx, y: ny)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> draw(_ dirtyRect: NSRect) {</span>
<span class="swiftcode">        <span class="swiftkeyword">super</span>.draw(dirtyRect)</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> bounds = <span class="swiftkeyword">self</span>.bounds</span>
<span class="swiftcode">        NSColor.green.<span class="swiftkeyword">set</span>()</span>
<span class="swiftcode">        NSBezierPath.fill(bounds)</span>
<span class="swiftcode">        </span>
<span class="swiftcode">        NSColor.white.<span class="swiftkeyword">set</span>()</span>
<span class="swiftcode">        path.stroke()</span>
<span class="swiftcode">    }</span>
<span class="swiftcode"></span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">var</span> intrinsicContentSize: NSSize {</span>
<span class="swiftcode">        <span class="swiftkeyword">return</span> NSSize(width: <span class="swiftnumber">400</span>, height: <span class="swiftnumber">400</span>)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> mouseDown(theEvent: NSEvent) {</span>
<span class="swiftcode">        NSLog(<span class="swiftstring">"mouseDown: </span></span><span class="codeswift">\<span class="swiftstring">(</span>theEvent.clickCount<span class="swiftstring">)</span></span><span class="swiftcode"><span class="swiftstring">"</span>)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> mouseDragged(theEvent: NSEvent) {</span>
<span class="swiftcode">        NSLog(<span class="swiftstring">"mouseDragged: </span></span><span class="codeswift">\<span class="swiftstring">(</span>theEvent.locationInWindow<span class="swiftstring">)</span></span><span class="swiftcode"><span class="swiftstring">"</span>)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> mouseUp(theEvent: NSEvent) {</span>
<span class="swiftcode">        NSLog(<span class="swiftstring">"mouseUp:"</span>)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode"></span>
<span class="swiftcode">}</span>
</pre>
</div>
	
	
	<h3>Adding the opacity slider</h3>
		
	<p>
	  We will add functionality to superimpose an image on the view using the mouse.
	  Additionally, a horizontal slider will be added to the user interface below the scroll view to control the opacity of the superimposed image.
	</p>

	<p>
	  Add an <code>@IBOutlet</code> named <code>stretchView</code> for your <code>StretchView</code> into the View Controller created as part of the default storyboard, and ensure that this @IBOutlet is bound to the <code>StretchView</code> seen in the <code>Main.storyboard</code> file, in the Interface Builder.
	</p>

	<p>
	  Drop a slider onto the window. It should be a child of the content view. In the inspector panel, set the slider's range from 0 to 1. Tick the check box that is labelled "Continuous".
	</p>

	<p>
	  Use "Add Constraints" to appropriately pin the left, bottom, and right of the slider to the containing window.

	  Also fix the pinning of the Bordered Scroll View. This can be done by selecting the Bordered Scroll View, and then double-clicking the yellow warning pop-up that appears if you adjust the bottom edge of the scroll view on the canvas. The previous value (20) is shown, but a pull-down allows you to select the canvas value.

	  Run your application to ensure that the slider and the scroll view are resizing as expected, when you resize the window.
	</p>

	<h3>Extending the StretchView class</h3>

	<p>
	  Change your <code>StretchView</code> class to incorporate the opacity and <code>NSImage</code> fields that we will need.
	</p>

	<div class="codeblock">
<div class="codeblocktitle"><a href="code/04/StretchView.swift">StretchView.swift</a></div>
<pre class="linenumbers unselectable" style="float: left;">01:
02:
03:
04:
05:
06:
07:
08:
09:
10:
11:
12:
13:
14:
15:
16:
17:
18:
19:
20:
21:
22:
23:
24:
25:
26:
27:
28:
29:
30:
31:
32:
33:
34:
35:
36:
37:
38:
39:
40:
41:
42:
43:
44:
45:
46:
47:
48:
49:
50:
51:
52:
53:
54:
55:
56:
57:
58:
59:
60:
61:
62:
63:
64:
65:
66:
67:
68:
69:
70:
71:
72:
</pre><pre class="code">
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"><span class="swiftcomment">//  StretchView.swift</span></span>
<span class="swiftcode"><span class="swiftcomment">//  DrawingFun</span></span>
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"><span class="swiftcomment">//  Created by David Eyers on 20/09/16.</span></span>
<span class="swiftcode"><span class="swiftcomment">//  Updated for Xcode 8.3 and Swift 3.x in September 2017</span></span>
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"></span>
<span class="swiftcode"><span class="swiftkeyword">import</span> Cocoa</span>
<span class="swiftcode"></span>
<span class="swiftcode"><span class="swiftkeyword">class</span> <span class="swiftdefined">StretchView</span>: NSView {</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">var</span> path = NSBezierPath()</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    dynamic <span class="swiftkeyword">var</span> opacity:<span class="swiftclass">Float</span> = <span class="swiftnumber">1</span>.<span class="swiftnumber">0</span> </span>
<span class="swiftcode">    dynamic <span class="swiftkeyword">var</span> image:NSImage = NSImage()</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    required <span class="swiftkeyword">init</span>?(coder: NSCoder) {</span>
<span class="swiftcode">        <span class="swiftkeyword">super</span>.<span class="swiftkeyword">init</span>(coder: coder)</span>
<span class="swiftcode">        srandom(<span class="swiftnumber">2</span>)</span>
<span class="swiftcode">        path.lineWidth = <span class="swiftnumber">3</span>.<span class="swiftnumber">0</span> </span>
<span class="swiftcode">        <span class="swiftkeyword">var</span> p:NSPoint = <span class="swiftkeyword">self</span>.randomPoint()</span>
<span class="swiftcode">        path.move(to: p)</span>
<span class="swiftcode">        </span>
<span class="swiftcode">        <span class="swiftkeyword">for</span> _ <span class="swiftkeyword">in</span> <span class="swiftnumber">0</span>...<span class="swiftnumber">14</span> {</span>
<span class="swiftcode">            p = <span class="swiftkeyword">self</span>.randomPoint()</span>
<span class="swiftcode">            path.line(to: p)</span>
<span class="swiftcode">        }</span>
<span class="swiftcode">        path.close()</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">func</span> randomPoint()-&gt;NSPoint {</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> r:NSRect = <span class="swiftkeyword">self</span>.bounds</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> nx = r.origin.x + CGFloat(<span class="swiftclass">Int</span>(arc4random()) % <span class="swiftclass">Int</span>(r.size.width))</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> ny = r.origin.y + CGFloat(<span class="swiftclass">Int</span>(arc4random()) % <span class="swiftclass">Int</span>(r.size.height))</span>
<span class="swiftcode">        <span class="swiftkeyword">return</span> NSPoint(x: nx, y: ny)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> draw(_ dirtyRect: NSRect) {</span>
<span class="swiftcode">        <span class="swiftkeyword">super</span>.draw(dirtyRect)</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> bounds = <span class="swiftkeyword">self</span>.bounds</span>
<span class="swiftcode">        NSColor.green.<span class="swiftkeyword">set</span>()</span>
<span class="swiftcode">        NSBezierPath.fill(bounds)</span>
<span class="swiftcode">        </span>
<span class="swiftcode">        NSColor.white.<span class="swiftkeyword">set</span>()</span>
<span class="swiftcode">        path.stroke()</span>
<span class="swiftcode">        </span>
<span class="swiftcode">        <span class="swiftcomment">// draw image</span></span>
<span class="swiftcode">        <span class="swiftkeyword">var</span> imageRect = NSRect()</span>
<span class="swiftcode">        imageRect.origin = NSZeroPoint</span>
<span class="swiftcode">        imageRect.size = image.size</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> drawingRect = imageRect</span>
<span class="swiftcode">        image.draw(<span class="swiftkeyword">in</span>: drawingRect, from: imageRect,</span>
<span class="swiftcode">                         operation: NSCompositingOperation.sourceOver,</span>
<span class="swiftcode">                         fraction: CGFloat(opacity))</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">var</span> intrinsicContentSize: NSSize {</span>
<span class="swiftcode">        <span class="swiftkeyword">return</span> NSSize(width: <span class="swiftnumber">400</span>, height: <span class="swiftnumber">400</span>)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> mouseDown(with theEvent: NSEvent) {</span>
<span class="swiftcode">        NSLog(<span class="swiftstring">"mouseDown: </span></span><span class="codeswift">\<span class="swiftstring">(</span>theEvent.clickCount<span class="swiftstring">)</span></span><span class="swiftcode"><span class="swiftstring">"</span>)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> mouseDragged(with theEvent: NSEvent) {</span>
<span class="swiftcode">        NSLog(<span class="swiftstring">"mouseDragged: </span></span><span class="codeswift">\<span class="swiftstring">(</span>theEvent.locationInWindow<span class="swiftstring">)</span></span><span class="swiftcode"><span class="swiftstring">"</span>)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> mouseUp(with theEvent: NSEvent) {</span>
<span class="swiftcode">        NSLog(<span class="swiftstring">"mouseUp:"</span>)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">}</span>
</pre>
</div>
	
	
	<h3>Binding the slider's value into our view controller</h3>
	
	<p>
	  This is a preview of bindings: we will discuss these further in the next lecture.
	</p>

	<p>
	  In the Interface Builder (for <code>Main.storyboard</code>), select the slider, and show its the Bindings Inspector.

	  Drop down the Value section, and select the "Bind to" checkbox, using the drop-down selection "View Controller".

	  For Model Key Path, enter <code>self.stretchView.opacity</code>. Xcode may not be able to autocomplete or find the symbol. Save your files before running your code.
	</p>

	<h3>Using an <code>NSOpenPanel</code></h3>

	<p>
	  We will use an <code>NSOpenPanel</code> to allow selection of an image that can be superimposed onto the view.

	  In the Application Scene's menu bar, right-click the "File" -> "Open" menu item to check that it is showing under "Sent Actions" the entry with left-hand-side "action" and right-hand-side "First Responder openDocument:". If this sent action is not present, control-drag the "Open..." menu item to the "First Responder" proxy object under the "Application Scene" in the Document Outline.
	  
	  Create an <code>IBAction</code> named <code>openDocument</code> in your view controller, including the implementation here.
	</p>
	
	<div class="codeblock">
<div class="codeblocktitle"><a href="code/04/ViewController.swift">ViewController.swift</a></div>
<pre class="linenumbers unselectable" style="float: left;">01:
02:
03:
04:
05:
06:
07:
08:
09:
10:
11:
12:
13:
14:
15:
16:
17:
18:
19:
20:
21:
22:
23:
24:
25:
26:
27:
28:
29:
30:
31:
32:
33:
34:
35:
36:
37:
38:
39:
</pre><pre class="code">
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"><span class="swiftcomment">//  ViewController.swift</span></span>
<span class="swiftcode"><span class="swiftcomment">//  DrawingFun</span></span>
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"><span class="swiftcomment">//  Created by David Eyers on 18/09/17.</span></span>
<span class="swiftcode"><span class="swiftcomment">//  Copyright © 2017 David Eyers. All rights reserved.</span></span>
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"></span>
<span class="swiftcode"><span class="swiftkeyword">import</span> Cocoa</span>
<span class="swiftcode"></span>
<span class="swiftcode"><span class="swiftkeyword">class</span> ViewController: NSViewController {</span>
<span class="swiftcode"></span>
<span class="swiftcode">    <span class="swiftkeyword">@IBOutlet</span> <span class="swiftkeyword">weak</span> <span class="swiftkeyword">var</span> stretchView: <span class="swiftdefined">StretchView</span>!</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> viewDidLoad() {</span>
<span class="swiftcode">        <span class="swiftkeyword">super</span>.viewDidLoad()</span>
<span class="swiftcode"></span>
<span class="swiftcode">        <span class="swiftcomment">// Do any additional setup after loading the view.</span></span>
<span class="swiftcode">    }</span>
<span class="swiftcode"></span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">var</span> representedObject: <span class="swiftclass">Any</span>? {</span>
<span class="swiftcode">        didSet {</span>
<span class="swiftcode">        <span class="swiftcomment">// Update the view, if already loaded.</span></span>
<span class="swiftcode">        }</span>
<span class="swiftcode">    }</span>
<span class="swiftcode"></span>
<span class="swiftcode">    <span class="swiftkeyword">@IBAction</span> <span class="swiftkeyword">func</span> openDocument(_ sender: <span class="swiftclass">AnyObject</span>) {</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> panel = NSOpenPanel()</span>
<span class="swiftcode">        panel.allowedFileTypes = NSImage.imageTypes()</span>
<span class="swiftcode">        panel.beginSheetModal(<span class="swiftkeyword">for</span>: stretchView.window!,</span>
<span class="swiftcode">                              completionHandler: { (returnCode)-&gt; Void <span class="swiftkeyword">in</span></span>
<span class="swiftcode">                                <span class="swiftkeyword">if</span> returnCode == NSModalResponseOK {</span>
<span class="swiftcode">                                    <span class="swiftkeyword">let</span> image = NSImage(byReferencing: panel.url!)</span>
<span class="swiftcode">                                    <span class="swiftkeyword">self</span>.stretchView.image = image</span>
<span class="swiftcode">                                    <span class="swiftkeyword">self</span>.stretchView.needsDisplay = <span class="swiftkeyword">true</span></span>
<span class="swiftcode">                                } } )</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">   </span>
<span class="swiftcode">}</span>
</pre>
</div>
	

	<p>
	  Test that your application can open an image, and that the image displays in the bottom-left of your scroll view.

	  The opacity slider will cause the opacity to change whenever the image is redrawn. For example, resizing the window will trigger a redrawing event.
	</p>

	<h3>Incorporating Mouse events</h3>

	<p>
	  We will now use <code>mouseDown</code> and <code>mouseUp</code> events to define where the image should be superimposed.

	  Note that every view has its own coordinate system, and (0,0) is in the lower-left corner. You can reconfigure the coordinate system if you wish.
	</p>

	<p>
	  If <code>a</code> and <code>b</code> are both <code>NSView</code>s and <code>p</code> is an <code>NSPoint</code>, you can convert <code>p</code> from <code>b</code> to <code>a</code>'s coordinates using:
	  <code>let pa:NSPoint = a.convertPoint(p, fromView: b)</code>. If <code>b</code> is <code>nil</code>, then the window's coordinate system is used instead. Mouse events have locations in the window's coordinate system.
	</p>

	<p>
	  Extend your <code>StretchView</code> to include the code below, that tracks mouse actions to position the image.
	</p>

	<div class="codeblock">
<div class="codeblocktitle"><a href="code/05/StretchView.swift">StretchView.swift</a></div>
<pre class="linenumbers unselectable" style="float: left;">01:
02:
03:
04:
05:
06:
07:
08:
09:
10:
11:
12:
13:
14:
15:
16:
17:
18:
19:
20:
21:
22:
23:
24:
25:
26:
27:
28:
29:
30:
31:
32:
33:
34:
35:
36:
37:
38:
39:
40:
41:
42:
43:
44:
45:
46:
47:
48:
49:
50:
51:
52:
53:
54:
55:
56:
57:
58:
59:
60:
61:
62:
63:
64:
65:
66:
67:
68:
69:
70:
71:
72:
73:
74:
75:
76:
77:
78:
79:
80:
81:
82:
83:
84:
85:
86:
87:
88:
89:
90:
91:
92:
93:
</pre><pre class="code">
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"><span class="swiftcomment">//  StretchView.swift</span></span>
<span class="swiftcode"><span class="swiftcomment">//  DrawingFun</span></span>
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"><span class="swiftcomment">//  Created by David Eyers on 20/09/16.</span></span>
<span class="swiftcode"><span class="swiftcomment">//  Updated for Xcode 8.3 and Swift 3.x in September 2017</span></span>
<span class="swiftcode"><span class="swiftcomment">//</span></span>
<span class="swiftcode"></span>
<span class="swiftcode"><span class="swiftkeyword">import</span> Cocoa</span>
<span class="swiftcode"></span>
<span class="swiftcode"><span class="swiftkeyword">class</span> <span class="swiftdefined">StretchView</span>: NSView {</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">var</span> path = NSBezierPath()</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    dynamic <span class="swiftkeyword">var</span> opacity:<span class="swiftclass">Float</span> = <span class="swiftnumber">0</span>.<span class="swiftnumber">5</span> </span>
<span class="swiftcode">    dynamic <span class="swiftkeyword">var</span> image:NSImage = NSImage()</span>
<span class="swiftcode"></span>
<span class="swiftcode">    <span class="swiftcomment">// where the mouse is first clicked</span></span>
<span class="swiftcode">    <span class="swiftkeyword">var</span> downPoint = NSPoint()</span>
<span class="swiftcode">    <span class="swiftcomment">// where it is dragged to, and released</span></span>
<span class="swiftcode">    <span class="swiftkeyword">var</span> currentPoint = NSPoint()</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    required <span class="swiftkeyword">init</span>?(coder: NSCoder) {</span>
<span class="swiftcode">        <span class="swiftkeyword">super</span>.<span class="swiftkeyword">init</span>(coder: coder)</span>
<span class="swiftcode">        srandom(<span class="swiftnumber">2</span>)</span>
<span class="swiftcode">        path.lineWidth = <span class="swiftnumber">3</span>.<span class="swiftnumber">0</span> </span>
<span class="swiftcode">        <span class="swiftkeyword">var</span> p:NSPoint = <span class="swiftkeyword">self</span>.randomPoint()</span>
<span class="swiftcode">        path.move(to: p)</span>
<span class="swiftcode">        </span>
<span class="swiftcode">        <span class="swiftkeyword">for</span> _ <span class="swiftkeyword">in</span> <span class="swiftnumber">0</span>...<span class="swiftnumber">14</span> {</span>
<span class="swiftcode">            p = <span class="swiftkeyword">self</span>.randomPoint()</span>
<span class="swiftcode">            path.line(to: p)</span>
<span class="swiftcode">        }</span>
<span class="swiftcode">        path.close()</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">func</span> randomPoint()-&gt;NSPoint {</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> r:NSRect = <span class="swiftkeyword">self</span>.bounds</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> nx = r.origin.x + CGFloat(<span class="swiftclass">Int</span>(arc4random()) % <span class="swiftclass">Int</span>(r.size.width))</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> ny = r.origin.y + CGFloat(<span class="swiftclass">Int</span>(arc4random()) % <span class="swiftclass">Int</span>(r.size.height))</span>
<span class="swiftcode">        <span class="swiftkeyword">return</span> NSPoint(x: nx, y: ny)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> draw(_ dirtyRect: NSRect) {</span>
<span class="swiftcode">        <span class="swiftkeyword">super</span>.draw(dirtyRect)</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> bounds = <span class="swiftkeyword">self</span>.bounds</span>
<span class="swiftcode">        NSColor.green.<span class="swiftkeyword">set</span>()</span>
<span class="swiftcode">        NSBezierPath.fill(bounds)</span>
<span class="swiftcode">        </span>
<span class="swiftcode">        NSColor.white.<span class="swiftkeyword">set</span>()</span>
<span class="swiftcode">        path.stroke()</span>
<span class="swiftcode">        </span>
<span class="swiftcode">        <span class="swiftcomment">// draw image</span></span>
<span class="swiftcode">        <span class="swiftkeyword">var</span> imageRect = NSRect()</span>
<span class="swiftcode">        imageRect.origin = NSZeroPoint</span>
<span class="swiftcode">        imageRect.size = image.size</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> drawingRect = imageRect</span>
<span class="swiftcode">        image.draw(<span class="swiftkeyword">in</span>: drawingRect, from: imageRect,</span>
<span class="swiftcode">                         operation: NSCompositingOperation.sourceOver,</span>
<span class="swiftcode">                         fraction: CGFloat(opacity))</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">var</span> intrinsicContentSize: NSSize {</span>
<span class="swiftcode">        <span class="swiftkeyword">return</span> NSSize(width: <span class="swiftnumber">400</span>, height: <span class="swiftnumber">400</span>)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> mouseDown(with theEvent: NSEvent) {</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> p = theEvent.locationInWindow</span>
<span class="swiftcode">        downPoint = convert(p, from: nil)</span>
<span class="swiftcode">        currentPoint = downPoint</span>
<span class="swiftcode">        <span class="swiftkeyword">self</span>.needsDisplay = <span class="swiftkeyword">true</span></span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> mouseDragged(with theEvent: NSEvent) {</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> p = theEvent.locationInWindow</span>
<span class="swiftcode">        currentPoint = convert(p, from: nil)</span>
<span class="swiftcode">        <span class="swiftkeyword">self</span>.needsDisplay = <span class="swiftkeyword">true</span></span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    <span class="swiftkeyword">override</span> <span class="swiftkeyword">func</span> mouseUp(with theEvent: NSEvent) {</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> p = theEvent.locationInWindow</span>
<span class="swiftcode">        currentPoint = convert(p, from: nil)</span>
<span class="swiftcode">        <span class="swiftkeyword">self</span>.needsDisplay = <span class="swiftkeyword">true</span></span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">    <span class="swiftkeyword">func</span> currentRect()-&gt;NSRect{</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> minX = min(downPoint.x, currentPoint.x)</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> maxX = max(downPoint.x, currentPoint.x)</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> minY = min(downPoint.y, currentPoint.y)</span>
<span class="swiftcode">        <span class="swiftkeyword">let</span> maxY = max(downPoint.y, currentPoint.y)</span>
<span class="swiftcode">        </span>
<span class="swiftcode">        <span class="swiftkeyword">return</span> NSMakeRect(minX, minY, maxX-minX, maxY-minY)</span>
<span class="swiftcode">    }</span>
<span class="swiftcode">    </span>
<span class="swiftcode">}</span>
</pre>
</div>
	

	<p>
	  The "setter" of opacity and image should be used to trigger <code>needsDisplay</code>, and should set a visible rectangle for the initial image placement. This functionality has been partially implemented by augmenting the ViewController as below.
	</p>

	<div class="codeblock">
<div class="codeblocktitle"><a href="code/05/ViewController.swift">ViewController.swift</a></div>
<pre class="code">
<span class="codeold"><span class="swiftcode">    <span class="swiftkeyword">@IBAction</span> <span class="swiftkeyword">func</span> openDocument(_ sender: <span class="swiftclass">AnyObject</span>) {</span></span>
<span class="codeold"><span class="swiftcode">        <span class="swiftkeyword">let</span> panel = NSOpenPanel()</span></span>
<span class="codeold"><span class="swiftcode">        panel.allowedFileTypes = NSImage.imageTypes()</span></span>
<span class="codeold"><span class="swiftcode">        panel.beginSheetModal(<span class="swiftkeyword">for</span>: stretchView.window!,</span></span>
<span class="codeold"><span class="swiftcode">                              completionHandler: { (returnCode)-&gt; Void <span class="swiftkeyword">in</span></span></span>
<span class="codeold"><span class="swiftcode">                                <span class="swiftkeyword">if</span> returnCode == NSModalResponseOK {</span></span>
<span class="codeold"><span class="swiftcode">                                    <span class="swiftkeyword">let</span> image = NSImage(byReferencing: panel.url!)</span></span>
<span class="codeold"><span class="swiftcode">                                    <span class="swiftkeyword">self</span>.stretchView.image = image</span></span>
<span class="swiftcode">                                    <span class="swiftkeyword">self</span>.stretchView.needsDisplay = <span class="swiftkeyword">true</span></span>
<span class="swiftcode">                                    <span class="swiftkeyword">self</span>.stretchView.downPoint = NSZeroPoint</span>
<span class="swiftcode">                                    <span class="swiftkeyword">self</span>.stretchView.currentPoint = NSPoint(x: image.size.width,</span>
<span class="swiftcode">                                                                            y: image.size.height)</span>
<span class="codeold"><span class="swiftcode">                                    </span></span>
<span class="codeold"><span class="swiftcode">                                } } )</span></span>
<span class="codeold"><span class="swiftcode">    }</span></span>
</pre>
</div>
	

	<h3>Autoscrolling</h3>

	<p>
	  When you drag beyond the edge of the scroll view, the view does not automatically scroll.

	  To enable this functionality, add <code>self.autoscroll(theEvent)</code> just before the <code>needsDisplay</code> line in your <code>mouseDragged</code> handler.
	</p>

	
	<h2>Exercises</h2>

	<p>
	  As time permits, do the following exercises. (They are derived from the exercises at the end of Chapters 17 and 18 in the 4th edition of Hillegass &amp; Preble.)
	</p>

	<h3>Exercise 1</h3>

	<p>
	  <code>NSBezierPath</code> can also draw Bezier curves. Replace the straight lines with randomly curved ones. (Hint: Look in the documentation for <code>NSBezierPath</code>.)
	</p>

	<h3>Exercise 2</h3>

	<p>
	  Create a new application that allows the user to draw ovals in arbitrary locations and sizes.  You might want to use the following convience initialiser method: <code>NSBezierPath(ovalInRect: yourRect:NSRect)</code>
	</p>
	
	</div>

	<div class="banner">
		<a href="../../labs.php">COSC346 - Object Oriented Programming and User Interfaces</a>
	</div>
	</body>
</html>

<!--  LocalWords:  Preble codekeyword mdash
 -->
